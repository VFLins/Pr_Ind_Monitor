---
title: "Relatório dos produtos encontrados"
output: 
    html_document:
        theme: paper
        toc: true
        toc_float: 
            collapsed: false
params:
    database:
        label: "Insira seu banco de dados SQLite gerado pelo Price_indexr"
        value: "C:/Users/vflin/Price_indexr/gpus.sqlite"
        input: file
    months:
        label: "Quantos meses de dados?"
        value: 7
        input: slider
        min: 1
        max: 61
        step: 1
        sep: " "
---

```{r setup, include=FALSE}
 
library(shiny)
library(dplyr)
library(tidyr)
require(scales)
library(ggplot2)
library(plotly)
library(stringr)
library(kableExtra)
library(zoo)
library(DBI)
library(RSQLite)

source("functions.R")

conn <- dbConnect(SQLite(), params$database)
tableNames <- dbListTables(conn)
PRODUCTS <- tableNames %>%
    str_remove("price_indexr-") %>% str_replace_all("_", " ") %>% str_to_upper()

DATES <- allowedDates(params$months)

DATASETS <- list()
for (tab in seq_along(tableNames)) {
    DATASETS[[PRODUCTS[tab]]] <- dbReadTable(conn, tableNames[tab]) %>%
        mutate(Date = as.Date(Date)) %>% .[.$Date %in% DATES,]
}
names(DATASETS) <- PRODUCTS
```

# Melhor oferta por loja*

```{r priceByStore}
DATASETS[[1]][1:6, c("Date", "Store", "Price")] %>% kable()
```

# Índice de preços

```{r}
plotIndexrOverTime(DATASETS)
```


### Histórico de preços individual {.tabset}

```{r echo=FALSE, fig.height=3, results='asis'}
for(i in seq_along(DATASETS)){
    catHeader(PRODUCTS[i], 4)
    plotPriceOverTime(DATASETS[[i]])
}
```
