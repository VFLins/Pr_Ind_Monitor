---
title: "Relatório dos produtos encontrados"
output: 
    html_document:
        theme: paper
        toc: true
        toc_float: 
            collapsed: false
params:
    database:
        label: "Insira seu banco de dados SQLite gerado pelo Price_indexr"
        value: "C:/Users/vflin/Price_indexr/gpus.sqlite"
        input: file
    months:
        label: "Quantos meses de dados?"
        value: 7
        input: slider
        min: 1
        max: 61
        step: 1
        sep: " "
---

```{r setup, include=FALSE}
library(shiny)
library(dplyr)
library(tidyr)
library(scales)
library(ggplot2)
library(plotly)
library(htmlwidgets)
library(stringr)
library(kableExtra)
library(zoo)
library(DBI)
library(RSQLite)

source("functions.R")

conn <- dbConnect(SQLite(), params$database)
tableNames <- dbListTables(conn)
PRODUCTS <- tableNames %>%
    str_remove("price_indexr-") %>% str_replace_all("_", " ") %>% str_to_upper()

DATES <- allowedDates(params$months)

DATASETS <- list()
for (tab in tableNames) {
    DATASETS[[tab]] <- dbReadTable(conn, tab) %>%
        mutate(Date = as.Date(Date)) %>% .[.$Date %in% DATES,]
}
names(DATASETS) <- PRODUCTS
```

### Melhor oferta por loja*

```{r priceByStore}
DATASETS[[1]][1:6, c("Date", "Store", "Price")] %>% kable()
```

### Índice de preços

Como vão os preços dos produtos, de maneira geral?

```{r echo=FALSE}
plotIndexrOverTime(DATASETS)
```


### Histórico de preços individual {.tabset .tabset-pills}

É assim que o preço deste produto tem se comportado:

```{r echo=FALSE, results='asis'}
for(i in seq_along(DATASETS)){
    fig <- plotPriceOverTime(DATASETS[[i]])
    
    catHeader(PRODUCTS[i], level = 4)
    print(htmltools::tagList(fig))
}
unlink("file.html")
```
